<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ISO 9001 - Contesto & SWOT (Input + Viewer)</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 1200px; margin: 28px auto; padding: 0 16px; }
    h1 { margin: 0 0 6px; }
    .muted { color: #666; font-size: 0.95rem; margin: 0 0 16px; }
    .card { border: 1px solid #e5e5e5; border-radius: 10px; padding: 14px; background: #fafafa; margin-bottom: 14px; }
    label { display:block; margin: 10px 0 6px; font-weight: 600; }
    input, select, textarea {
      width: 100%;
      padding: 9px;
      box-sizing: border-box;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 14px;
      background: #fff;
    }
    textarea { min-height: 90px; resize: vertical; }
    .actions { margin-top: 12px; display:flex; gap: 10px; align-items:center; flex-wrap: wrap; }
    button {
      padding: 9px 12px;
      border: 0;
      border-radius: 8px;
      background: #1a73e8;
      color: #fff;
      cursor: pointer;
      font-weight: 600;
    }
    button.secondary { background: #666; }
    button:disabled { opacity: 0.6; cursor: not-allowed; }
    .ok { color: #0a6; font-weight: 600; }
    .err { color: #b00; font-weight: 600; }

    details { background:#fff; border:1px solid #e5e5e5; border-radius:10px; padding:10px; margin-top:12px; }
    summary { cursor:pointer; font-weight:700; }

    iframe { width: 100%; height: 520px; border: 1px solid #ddd; border-radius: 10px; background: #fff; }
  </style>
</head>

<body>
  <h1>ISO 9001 – Contesto & SWOT</h1>
  <p class="muted">
    Inserisci una nuova riga in <b>SWOT_input</b>. Il viewer sotto mostra solo le prime <b>20 righe</b> e le sole <b>14 colonne</b>.
  </p>

  <div class="card">
    <h3 style="margin:0 0 10px;">Nuova riga (Insert)</h3>

    <form id="insertForm" autocomplete="on">
      <label for="anno">Anno</label>
      <input id="anno" name="anno" type="number" min="2000" max="2100" required placeholder="2025" />

      <label for="contesto">Contesto</label>
      <select id="contesto" name="contesto" required>
        <option value="" selected disabled>Seleziona…</option>
        <option>ECONOMICO</option>
        <option>TECNOLOGICO</option>
        <option>LEGALE</option>
        <option>POLITICO / REGOLATORIO</option>
        <option>SOCIALE</option>
        <option>AMBIENTALE / CLIMATICO</option>
        <option>MERCATO / DOMANDA</option>
        <option>VENDITE E CUSTOMER CARE</option>
        <option>AREA FINANZA</option>
        <option>RISORSE UMANE</option>
        <option>INFRASTRUTTURE / ASSET</option>
        <option>SUPPLY CHAIN / FORNITORI</option>
        <option>QUALITÀ E PROCESSI</option>
        <option>CYBERSECURITY / IT</option>
        <option>LOGISTICA</option>
        <option>REPUTAZIONE / BRAND</option>
        <option>CONCORRENZA</option>
        <option>INNOVAZIONE / R&D</option>
        <option>COMPLIANCE / ETICA</option>
        <option>SALUTE E SICUREZZA (OHS)</option>
      </select>

      <label for="attivita">Attività</label>
      <textarea id="attivita" name="attivita" required placeholder="Descrivi attività / processo / evento…"></textarea>

      <label for="partiInteressate">Parti interessate</label>
      <select id="partiInteressate" name="partiInteressate" required>
        <option value="" selected disabled>Seleziona…</option>
        <option>CLIENTI</option>
        <option>PROSPECT / MERCATO POTENZIALE</option>
        <option>COMPETITORS</option>
        <option>FORNITORI</option>
        <option>PARTNER / ALLEANZE</option>
        <option>SOCIETÀ DI INGEGNERIA</option>
        <option>STUDI DI ARCHITETTURA</option>
        <option>CONSULENTI</option>
        <option>ISTITUTI DI CREDITO / BANCHE</option>
        <option>AGENZIA DELLE ENTRATE</option>
        <option>INAIL</option>
        <option>ENTI REGOLATORI / PA</option>
        <option>ORGANISMI DI CERTIFICAZIONE</option>
        <option>ASSICURAZIONI</option>
        <option>DIPENDENTI</option>
        <option>COLLABORATORI / FREELANCE</option>
        <option>PROPRIETÀ / SOCI</option>
        <option>COMUNITÀ LOCALE</option>
        <option>ASSOCIAZIONI DI CATEGORIA</option>
        <option>MEDIA / OPINIONE PUBBLICA</option>
      </select>

      <label for="obiettivoAnte">Obiettivo (Ante)</label>
      <textarea id="obiettivoAnte" name="obiettivoAnte" required placeholder="Obiettivo pianificato (ante)…"></textarea>

      <label for="swotAnte">SWOT (Ante)</label>
      <select id="swotAnte" name="swotAnte" required>
        <option value="" selected disabled>Seleziona…</option>
        <option>FORZA</option>
        <option>DEBOLEZZA</option>
        <option>OPPORTUNITÀ</option>
        <option>MINACCIA</option>
      </select>

      <label for="fattoreAnte">Fattore Interno - Esterno (Ante)</label>
      <select id="fattoreAnte" name="fattoreAnte" required>
        <option value="" selected disabled>Seleziona…</option>
        <option>Fattore Interno</option>
        <option>Fattore Esterno</option>
      </select>

      <label for="roAnte">R / O (Ante)</label>
      <select id="roAnte" name="roAnte" required>
        <option value="" selected disabled>Seleziona…</option>
        <option>RISCHIO</option>
        <option>OPPORTUNITÀ</option>
      </select>

      <details>
        <summary>Sezione POST (opzionale)</summary>

        <label for="annoRilevazionePost">Anno di Rilevazione (POST)</label>
        <input id="annoRilevazionePost" name="annoRilevazionePost" type="number" min="2000" max="2100" placeholder="2026" />

        <label for="esitoPost">Esito POST</label>
        <textarea id="esitoPost" name="esitoPost" placeholder="Esito / evidenza oggettiva…"></textarea>

        <label for="swotPost">SWOT (POST)</label>
        <select id="swotPost" name="swotPost">
          <option value="" selected>(vuoto)</option>
          <option>FORZA</option>
          <option>DEBOLEZZA</option>
          <option>OPPORTUNITÀ</option>
          <option>MINACCIA</option>
        </select>

        <label for="fattorePost">Fattore Interno - Esterno (POST)</label>
        <select id="fattorePost" name="fattorePost">
          <option value="" selected>(vuoto)</option>
          <option>Fattore Interno</option>
          <option>Fattore Esterno</option>
        </select>

        <label for="roPost">R / O (POST)</label>
        <select id="roPost" name="roPost">
          <option value="" selected>(vuoto)</option>
          <option>RISCHIO</option>
          <option>OPPORTUNITÀ</option>
        </select>

        <label for="commentoPost">Commento POST</label>
        <textarea id="commentoPost" name="commentoPost" placeholder="Commento finale…"></textarea>
      </details>

      <!-- Honeypot -->
      <div style="display:none;">
        <label>Se sei umano lascia vuoto</label>
        <input name="hp" tabindex="-1" autocomplete="off" />
      </div>

      <div class="actions">
        <button id="insertBtn" type="submit">Inserisci</button>
        <span id="insertStatus" class="muted"></span>
      </div>
    </form>
  </div>

  <div class="card">
    <h3 style="margin:0 0 10px;">Viewer (20 righe, 14 colonne)</h3>
    <p class="muted">
      Il viewer legge direttamente <b>SWOT_input</b> e mostra solo un estratto (limit 20).
    </p>

    <iframe id="sheetFrame" loading="lazy"></iframe>

    <div class="actions">
      <button id="viewerRefreshBtn" type="button" class="secondary">Aggiorna viewer</button>
      <span class="muted">Forza refresh (cache-bust) del viewer.</span>
    </div>
  </div>

  <script>
    // ===== CONFIG =====
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbw2qic068iX9kN-RQUPY-5umBrfmPDPzaoPtECa3u40Zae0FXnefG6q2KUh9HfwLgAS/exec";
    const API_KEY = "Djungo-Test-2026-01-17-chiave-lunga-XYZ";

    // Viewer locale (GitHub Pages) che limita righe/colonne in modo robusto
    const VIEWER_PAGE = "viewer.html";

    function setMsg(el, msg, cls) {
      el.className = cls || "muted";
      el.textContent = msg;
    }

    // ===== iframe init + refresh =====
    const sheetFrame = document.getElementById("sheetFrame");
    const viewerRefreshBtn = document.getElementById("viewerRefreshBtn");

    function refreshViewer() {
      const url = new URL(VIEWER_PAGE, window.location.href);
      url.searchParams.set("_", Date.now().toString());
      sheetFrame.src = url.toString();
    }

    viewerRefreshBtn.addEventListener("click", refreshViewer);
    refreshViewer(); // init

    // ===== JSONP helper =====
    function jsonp(url) {
      return new Promise((resolve, reject) => {
        const cbName = "cb_" + Math.random().toString(36).slice(2);
        const script = document.createElement("script");
        const timeout = setTimeout(() => {
          cleanup();
          reject(new Error("Timeout JSONP"));
        }, 15000);

        function cleanup() {
          clearTimeout(timeout);
          script.remove();
          try { delete window[cbName]; } catch (_) { window[cbName] = undefined; }
        }

        window[cbName] = (data) => {
          cleanup();
          resolve(data);
        };

        const u = new URL(url);
        u.searchParams.set("cb", cbName);
        script.src = u.toString();
        script.onerror = () => {
          cleanup();
          reject(new Error("JSONP load error"));
        };

        document.body.appendChild(script);
      });
    }

    // ===== INSERT =====
    const insertForm = document.getElementById("insertForm");
    const insertBtn = document.getElementById("insertBtn");
    const insertStatus = document.getElementById("insertStatus");

    insertForm.addEventListener("submit", async (ev) => {
      ev.preventDefault();
      insertBtn.disabled = true;
      setMsg(insertStatus, "Invio in corso...", "muted");

      const fd = new FormData(insertForm);

      const payload = {
        anno: (fd.get("anno") || "").toString().trim(),
        contesto: (fd.get("contesto") || "").toString().trim(),
        attivita: (fd.get("attivita") || "").toString().trim(),
        partiInteressate: (fd.get("partiInteressate") || "").toString().trim(),
        obiettivoAnte: (fd.get("obiettivoAnte") || "").toString().trim(),
        swotAnte: (fd.get("swotAnte") || "").toString().trim(),
        fattoreAnte: (fd.get("fattoreAnte") || "").toString().trim(),
        roAnte: (fd.get("roAnte") || "").toString().trim(),

        // POST opzionale
        annoRilevazionePost: (fd.get("annoRilevazionePost") || "").toString().trim(),
        esitoPost: (fd.get("esitoPost") || "").toString().trim(),
        swotPost: (fd.get("swotPost") || "").toString().trim(),
        fattorePost: (fd.get("fattorePost") || "").toString().trim(),
        roPost: (fd.get("roPost") || "").toString().trim(),
        commentoPost: (fd.get("commentoPost") || "").toString().trim(),

        hp: (fd.get("hp") || "").toString()
      };

      // check minimo (ANTE)
      if (!payload.anno || !payload.contesto || !payload.attivita || !payload.partiInteressate ||
          !payload.obiettivoAnte || !payload.swotAnte || !payload.fattoreAnte || !payload.roAnte) {
        setMsg(insertStatus, "Compila tutti i campi obbligatori (ANTE).", "err");
        insertBtn.disabled = false;
        return;
      }

      const u = new URL(WEB_APP_URL);
      u.searchParams.set("mode", "insert");
      u.searchParams.set("apiKey", API_KEY);

      // parametri
      u.searchParams.set("hp", payload.hp);
      u.searchParams.set("anno", payload.anno);
      u.searchParams.set("contesto", payload.contesto);
      u.searchParams.set("attivita", payload.attivita);
      u.searchParams.set("partiInteressate", payload.partiInteressate);
      u.searchParams.set("obiettivoAnte", payload.obiettivoAnte);
      u.searchParams.set("swotAnte", payload.swotAnte);
      u.searchParams.set("fattoreAnte", payload.fattoreAnte);
      u.searchParams.set("roAnte", payload.roAnte);

      u.searchParams.set("annoRilevazionePost", payload.annoRilevazionePost);
      u.searchParams.set("esitoPost", payload.esitoPost);
      u.searchParams.set("swotPost", payload.swotPost);
      u.searchParams.set("fattorePost", payload.fattorePost);
      u.searchParams.set("roPost", payload.roPost);
      u.searchParams.set("commentoPost", payload.commentoPost);

      try {
        const resp = await jsonp(u.toString());

        if (!resp || resp.ok !== true) {
          setMsg(insertStatus, "Errore: " + (resp && resp.error ? resp.error : "Risposta non valida"), "err");
          insertBtn.disabled = false;
          return;
        }

        setMsg(insertStatus, "Inserito. Aggiorno il viewer…", "ok");
        insertForm.reset();
        refreshViewer();

      } catch (e) {
        setMsg(insertStatus, "Errore rete/JSONP: " + e.message, "err");
      } finally {
        insertBtn.disabled = false;
      }
    });
  </script>
</body>
</html>







