<script>
  // ===== CONFIG =====
  const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbyKS8sN118DOSPSYKjybVrSLNC3W696_FTQfGEIMs-bWnEKabz8VibDAgckBmPFYmTP/exec";
  const API_KEY = "Djungo-Test-2026-01-17-chiave-lunga-XYZ";

  // iframe pubblicato (punta al foglio/Tab che vuoi mostrare)
  const FRAME_BASE_SRC = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTUnecuOwa6Pt3oHkGnR16o4bsQ0VV_MsdhZNx2cpz3fbpPFLqLur6B94ujVXdOPlTNFas_qc32UX3L/pubhtml?gid=1648418620&single=true&widget=true&headers=false";

  function setMsg(el, msg, cls) {
    el.className = cls || "muted";
    el.textContent = msg;
  }

  // ===== Viewer refresh (cache bust) =====
  const sheetFrame = document.getElementById("sheetFrame");
  const viewerRefreshBtn = document.getElementById("viewerRefreshBtn");

  function refreshViewer() {
    const url = new URL(FRAME_BASE_SRC);
    url.searchParams.set("_", Date.now().toString());
    sheetFrame.src = url.toString();
  }

  viewerRefreshBtn.addEventListener("click", refreshViewer);

  // ===== JSONP helper =====
  function jsonp(url) {
    return new Promise((resolve, reject) => {
      const cbName = "cb_" + Math.random().toString(36).slice(2);
      const script = document.createElement("script");
      const timeout = setTimeout(() => {
        cleanup();
        reject(new Error("Timeout JSONP"));
      }, 15000);

      function cleanup() {
        clearTimeout(timeout);
        script.remove();
        try { delete window[cbName]; } catch (_) { window[cbName] = undefined; }
      }

      window[cbName] = (data) => {
        cleanup();
        resolve(data);
      };

      const u = new URL(url);
      u.searchParams.set("cb", cbName);
      script.src = u.toString();
      script.onerror = () => {
        cleanup();
        reject(new Error("JSONP load error"));
      };

      document.body.appendChild(script);
    });
  }

  // ===== INSERT =====
  const insertForm = document.getElementById("insertForm");
  const insertBtn = document.getElementById("insertBtn");
  const insertStatus = document.getElementById("insertStatus");
  const fattoreAnteEl = document.getElementById("fattoreAnte");
  const pillFactorEl = document.getElementById("pillFactor");

  fattoreAnteEl.addEventListener("change", () => {
    const v = (fattoreAnteEl.value || "");
    if (!v) { pillFactorEl.textContent = "—"; return; }
    const [pct, label] = v.split("|");
    pillFactorEl.textContent = `${pct}% • ${label}`;
  });

  insertForm.addEventListener("submit", async (ev) => {
    ev.preventDefault();
    insertBtn.disabled = true;
    setMsg(insertStatus, "Invio in corso...", "muted");

    const fd = new FormData(insertForm);

    // NOTA: ora inviamo a Apps Script la data ISO direttamente (YYYY-MM-DD)
    const dataRilevazione = (fd.get("dataRilevazione") || "").toString().trim();
    const areaContesto = (fd.get("areaContesto") || "").toString().trim();
    const attivita = (fd.get("attivita") || "").toString().trim();
    const partiInteressate = (fd.get("partiInteressate") || "").toString().trim();
    const obiettivo = (fd.get("obiettivo") || "").toString().trim();
    const fattoreAnte = (fd.get("fattoreAnte") || "").toString().trim();
    const hp = (fd.get("hp") || "").toString();

    if (!dataRilevazione || !areaContesto || !attivita || !partiInteressate || !obiettivo || !fattoreAnte) {
      setMsg(insertStatus, "Compila tutti i campi obbligatori.", "err");
      insertBtn.disabled = false;
      return;
    }

    const [factorPctStr, factorLabel] = fattoreAnte.split("|");
    const factorPct = Number(factorPctStr || 0);

    const u = new URL(WEB_APP_URL);
    u.searchParams.set("mode", "insert");
    u.searchParams.set("apiKey", API_KEY);
    u.searchParams.set("hp", hp);

    u.searchParams.set("dataRilevazione", dataRilevazione); // YYYY-MM-DD
    u.searchParams.set("areaContesto", areaContesto);
    u.searchParams.set("attivita", attivita);
    u.searchParams.set("partiInteressate", partiInteressate);
    u.searchParams.set("obiettivo", obiettivo);
    u.searchParams.set("factorPct", String(factorPct));
    u.searchParams.set("factorLabel", factorLabel);

    try {
      const resp = await jsonp(u.toString());

      if (!resp || resp.ok !== true) {
        setMsg(insertStatus, "Errore: " + (resp && resp.error ? resp.error : "Risposta non valida"), "err");
        insertBtn.disabled = false;
        return;
      }

      setMsg(insertStatus, "Inserito. Aggiorno il viewer…", "ok");
      insertForm.reset();
      pillFactorEl.textContent = "—";
      refreshViewer();

    } catch (e) {
      setMsg(insertStatus, "Errore rete/JSONP: " + e.message, "err");
    } finally {
      insertBtn.disabled = false;
    }
  });

  // ===== UPDATE / DELETE =====
  // Per ora lasciamo i form in pagina ma NON li colleghiamo (fase successiva).
  // Quando riattiveremo il CRUD, aggiungiamo mode=update/delete in Apps Script e JSONP analoghi.
</script>








