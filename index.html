<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Inserimento dati</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 720px; margin: 40px auto; padding: 0 16px; }
    label { display:block; margin: 12px 0 6px; }
    input, textarea { width: 100%; padding: 10px; box-sizing: border-box; }
    textarea { min-height: 140px; }
    button { padding: 10px 14px; margin-top: 14px; }
    .muted { color: #666; font-size: 0.9rem; }
    .ok { color: #0a6; }
    .err { color: #b00; }
    .hidden { display:none; }
  </style>
</head>
<body>
  <h1>Invio richiesta</h1>
  <p class="muted">Compila i campi e invia. I dati verranno registrati automaticamente.</p>

  <form id="f" autocomplete="on">
    <label>Nome e Cognome</label>
    <input name="name" maxlength="80" required />

    <label>Email</label>
    <input name="email" type="email" maxlength="120" required />

    <label>Messaggio</label>
    <textarea name="message" maxlength="2000" required></textarea>

    <!-- Honeypot: deve restare vuoto (non dirlo all’utente) -->
    <div class="hidden">
      <label>Se sei umano lascia vuoto</label>
      <input name="hp" tabindex="-1" autocomplete="off" />
    </div>

    <button id="btn" type="submit">Invia</button>
  </form>

  <p id="status" class="muted"></p>

  <script>
    // 1) Inserisci qui i tuoi valori
    WEB_APP_URL="https://script.google.com/macros/s/AKfycbysG3O_nsBSXv4AdrHjyRfXBwIsPQ7J-pKHn7vV3ZwVdmyTFa5V0ai0pYxV48TV7RTd/exec"
    API_KEY="Djungo-Test-2026-01-17-chiave-lunga-XYZ"

    // 2) Timestamp di apertura pagina (anti-bot “too fast”)
    const pageLoadTs = Date.now();

    const form = document.getElementById("f");
    const statusEl = document.getElementById("status");
    const btn = document.getElementById("btn");

    function setStatus(msg, cls) {
      statusEl.className = cls || "muted";
      statusEl.textContent = msg;
    }

    form.addEventListener("submit", async (ev) => {
      ev.preventDefault();

      // Anti doppio invio
      btn.disabled = true;
      setStatus("Invio in corso...", "muted");

      const fd = new FormData(form);

      // Validazioni lato client (extra)
      const name = (fd.get("name") || "").toString().trim();
      const email = (fd.get("email") || "").toString().trim();
      const message = (fd.get("message") || "").toString().trim();

      if (!name || !email || !message) {
        setStatus("Compila tutti i campi.", "err");
        btn.disabled = false;
        return;
      }

      const payload = {
        apiKey: API_KEY,
        ts: pageLoadTs,
        hp: (fd.get("hp") || "").toString(),
        name,
        email,
        message,
        userAgent: navigator.userAgent
      };

      try {
        const res = await fetch(WEB_APP_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        const data = await res.json().catch(() => null);

        if (!res.ok || !data || !data.ok) {
          const errMsg = (data && data.error) ? data.error : ("HTTP " + res.status);
          setStatus("Errore invio: " + errMsg, "err");
          btn.disabled = false;
          return;
        }

        setStatus("Inviato correttamente.", "ok");
        form.reset();

      } catch (e) {
        setStatus("Errore di rete: " + e, "err");
      } finally {
        btn.disabled = false;
      }
    });
  </script>
</body>
</html>
