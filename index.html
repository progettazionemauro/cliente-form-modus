<script>
  // ===== CONFIG =====
  const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbznxZL1iXMew8yhfTixVfmF1dPI9_VUzo2_52wWpXdGzJ1lKoCP3hPB2hcDJZKCPLjb/exec";
  const API_KEY = "Djungo-Test-2026-01-17-chiave-lunga-XYZ";

  // Timestamp per anti-bot (lato server è 0, quindi non blocca)
  const pageLoadTs = Date.now();

  const form = document.getElementById("f");
  const statusEl = document.getElementById("status");
  const btn = document.getElementById("btn");
  const fattoreAnteEl = document.getElementById("fattoreAnte");
  const pillFactorEl = document.getElementById("pillFactor");

  const reloadBtn = document.getElementById("reloadBtn");
  const tb = document.getElementById("tb");
  const searchEl = document.getElementById("search");
  const countEl = document.getElementById("count");

  let currentRows = [];

  function setStatus(msg, cls) {
    statusEl.className = cls || "muted";
    statusEl.textContent = msg;
  }

  function isoToDDMMYY(iso) {
    const m = /^(\d{4})-(\d{2})-(\d{2})$/.exec(iso);
    if (!m) return "";
    const yy = m[1].slice(2);
    return `${m[3]}/${m[2]}/${yy}`;
  }

  fattoreAnteEl.addEventListener("change", () => {
    const v = (fattoreAnteEl.value || "");
    if (!v) { pillFactorEl.textContent = "—"; return; }
    const [pct, label] = v.split("|");
    pillFactorEl.textContent = `${pct}% • ${label}`;
  });

  // ========= JSONP LIST (robusto) =========
  function loadRowsJsonp(limit = 300) {
    return new Promise((resolve) => {
      const cbName = "cb_" + Date.now().toString(36) + "_" + Math.random().toString(36).slice(2);

      // Timeout “vero”: se JSONP non risponde entro N ms, falliamo
      const timeoutMs = 6000;
      let done = false;

      function finish(payload) {
        if (done) return;
        done = true;
        resolve(payload);
      }

      window[cbName] = (data) => {
        try {
          finish(data);
        } finally {
          // cleanup callback globale
          try { delete window[cbName]; } catch (_) { window[cbName] = undefined; }
          // rimozione script tag collegato
          try {
            const el = document.getElementById(cbName);
            if (el) el.remove();
          } catch (_) {}
        }
      };

      const url = new URL(WEB_APP_URL);
      url.searchParams.set("mode", "list");
      url.searchParams.set("apiKey", API_KEY);
      url.searchParams.set("callback", cbName);
      url.searchParams.set("limit", String(limit));
      // cache buster forte
      url.searchParams.set("_", String(Date.now()));

      const s = document.createElement("script");
      s.id = cbName;
      s.src = url.toString();

      s.onerror = () => {
        // cleanup
        try { delete window[cbName]; } catch (_) {}
        try { s.remove(); } catch (_) {}
        finish({ ok: false, error: "JSONP load error (script.onerror)" });
      };

      document.body.appendChild(s);

      // timeout
      setTimeout(() => {
        if (done) return;
        try { delete window[cbName]; } catch (_) {}
        try { s.remove(); } catch (_) {}
        finish({ ok: false, error: "JSONP timeout" });
      }, timeoutMs);
    });
  }

  function escapeHtml(s) {
    return String(s)
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");
  }

  function render(rows) {
    const q = (searchEl.value || "").trim().toLowerCase();

    const filtered = !q ? rows : rows.filter(r => {
      const blob = [
        r.dataRilevazione, r.areaContesto, r.attivita, r.partiInteressate, r.obiettivo,
        String(r.factorPct || ""), r.factorLabel, r.recordId
      ].join(" ").toLowerCase();
      return blob.includes(q);
    });

    tb.innerHTML = "";
    // NB: rows sono già in ordine naturale; qui mostriamo le più recenti sopra
    for (const r of filtered.slice().reverse()) {
      const tr = document.createElement("tr");
      tr.dataset.id = r.recordId;

      tr.innerHTML = `
        <td class="nowrap">
          <div class="row-actions">
            <button type="button" class="secondary" data-act="edit">Modifica</button>
            <button type="button" class="hidden" data-act="save">Salva</button>
            <button type="button" class="hidden danger" data-act="cancel">Annulla</button>
          </div>
        </td>
        <td class="nowrap" data-k="dataRilevazione">${escapeHtml(r.dataRilevazione || "")}</td>
        <td data-k="areaContesto">${escapeHtml(r.areaContesto || "")}</td>
        <td data-k="attivita">${escapeHtml(r.attivita || "")}</td>
        <td data-k="partiInteressate">${escapeHtml(r.partiInteressate || "")}</td>
        <td data-k="obiettivo">${escapeHtml(r.obiettivo || "")}</td>
        <td class="nowrap" data-k="fattore">${escapeHtml(String(r.factorPct || ""))}% • ${escapeHtml(r.factorLabel || "")}</td>
        <td class="nowrap"><small>${escapeHtml(r.recordId || "")}</small></td>
      `;

      tb.appendChild(tr);
    }

    countEl.textContent = `Righe: ${filtered.length} / ${rows.length}`;
  }

  async function refresh() {
    countEl.textContent = "Caricamento...";
    // Tentativo 1
    let data = await loadRowsJsonp(500);

    // Se fallisce, ritento una volta (spesso basta)
    if (!data || !data.ok) {
      data = await loadRowsJsonp(500);
    }

    if (!data || !data.ok) {
      countEl.textContent = "Errore caricamento tabella.";
      console.error("loadRows error:", data);
      return;
    }

    currentRows = data.rows || [];
    render(currentRows);
  }

  reloadBtn.addEventListener("click", refresh);
  searchEl.addEventListener("input", () => render(currentRows));

  // ===== INSERT =====
  form.addEventListener("submit", async (ev) => {
    ev.preventDefault();
    btn.disabled = true;
    setStatus("Invio in corso...", "muted");

    const fd = new FormData(form);

    const isoDate = (fd.get("dataRilevazione") || "").toString().trim();
    const dataRilevazione = isoToDDMMYY(isoDate);

    const areaContesto = (fd.get("areaContesto") || "").toString().trim();
    const attivita = (fd.get("attivita") || "").toString().trim();
    const partiInteressate = (fd.get("partiInteressate") || "").toString().trim();
    const obiettivo = (fd.get("obiettivo") || "").toString().trim();
    const fattoreAnte = (fd.get("fattoreAnte") || "").toString().trim();
    const hp = (fd.get("hp") || "").toString();

    if (!dataRilevazione || !areaContesto || !attivita || !partiInteressate || !obiettivo || !fattoreAnte) {
      setStatus("Compila tutti i campi obbligatori.", "err");
      btn.disabled = false;
      return;
    }

    const [factorPctStr, factorLabel] = fattoreAnte.split("|");
    const factorPct = Number(factorPctStr || 0);

    const payload = {
      mode: "insert",
      apiKey: API_KEY,
      ts: pageLoadTs,
      hp: hp,

      dataRilevazione,
      areaContesto,
      attivita,
      partiInteressate,
      obiettivo,
      factorPct,
      factorLabel
      // userAgent: navigator.userAgent  // (commentato) utile per debug
    };

    try {
      // NB: no-cors → non possiamo leggere la risposta, ma la riga viene scritta
      await fetch(WEB_APP_URL, {
        method: "POST",
        mode: "no-cors",
        headers: { "Content-Type": "text/plain;charset=utf-8" },
        body: JSON.stringify(payload)
      });

      // Aspetto un attimo: Sheets può impiegare qualche centinaio di ms a rendere la riga visibile in lettura
      setStatus("Inserito. Aggiorno tabella…", "ok");
      form.reset();
      pillFactorEl.textContent = "—";

      // micro-delay + refresh
      setTimeout(async () => {
        await refresh();
        setStatus("OK.", "ok");
      }, 350);

    } catch (e) {
      setStatus("Errore di rete: " + e, "err");
    } finally {
      btn.disabled = false;
    }
  });

  // ===== EDIT / UPDATE (inline) =====
  tb.addEventListener("click", async (ev) => {
    const btnEl = ev.target.closest("button");
    if (!btnEl) return;

    const tr = ev.target.closest("tr");
    if (!tr) return;

    const recordId = tr.dataset.id;
    const act = btnEl.dataset.act;

    if (act === "edit") { enterEditMode(tr); return; }
    if (act === "cancel") { exitEditMode(tr, true); return; }
    if (act === "save") { await saveRow(tr, recordId); return; }
  });

  function enterEditMode(tr) {
    tr.dataset.snapshot = JSON.stringify({
      dataRilevazione: tr.querySelector('[data-k="dataRilevazione"]').textContent.trim(),
      areaContesto: tr.querySelector('[data-k="areaContesto"]').textContent.trim(),
      attivita: tr.querySelector('[data-k="attivita"]').textContent.trim(),
      partiInteressate: tr.querySelector('[data-k="partiInteressate"]').textContent.trim(),
      obiettivo: tr.querySelector('[data-k="obiettivo"]').textContent.trim(),
      fattore: tr.querySelector('[data-k="fattore"]').textContent.trim()
    });

    makeInput(tr, "dataRilevazione", "text");
    makeInput(tr, "areaContesto", "text");
    makeInput(tr, "attivita", "textarea");
    makeInput(tr, "partiInteressate", "text");
    makeInput(tr, "obiettivo", "textarea");
    makeInput(tr, "fattore", "text");

    toggleRowButtons(tr, true);
  }

  function makeInput(tr, key, type) {
    const td = tr.querySelector(`[data-k="${key}"]`);
    if (!td) return;
    const val = td.textContent.trim();

    if (type === "textarea") {
      td.innerHTML = `<textarea class="cell-input" data-in="${key}">${escapeHtml(val)}</textarea>`;
    } else {
      td.innerHTML = `<input class="cell-input" data-in="${key}" value="${escapeHtml(val)}" />`;
    }
  }

  function toggleRowButtons(tr, editing) {
    const editBtn = tr.querySelector('button[data-act="edit"]');
    const saveBtn = tr.querySelector('button[data-act="save"]');
    const cancelBtn = tr.querySelector('button[data-act="cancel"]');

    if (editing) {
      editBtn.classList.add("hidden");
      saveBtn.classList.remove("hidden");
      cancelBtn.classList.remove("hidden");
    } else {
      editBtn.classList.remove("hidden");
      saveBtn.classList.add("hidden");
      cancelBtn.classList.add("hidden");
    }
  }

  function exitEditMode(tr, restore) {
    if (restore) {
      const snap = JSON.parse(tr.dataset.snapshot || "{}");
      tr.querySelector('[data-k="dataRilevazione"]').textContent = snap.dataRilevazione || "";
      tr.querySelector('[data-k="areaContesto"]').textContent = snap.areaContesto || "";
      tr.querySelector('[data-k="attivita"]').textContent = snap.attivita || "";
      tr.querySelector('[data-k="partiInteressate"]').textContent = snap.partiInteressate || "";
      tr.querySelector('[data-k="obiettivo"]').textContent = snap.obiettivo || "";
      tr.querySelector('[data-k="fattore"]').textContent = snap.fattore || "";
    }
    delete tr.dataset.snapshot;
    toggleRowButtons(tr, false);
  }

  function parseFattoreCell(text) {
    const t = String(text || "").trim();
    const m = /^(\d+)\s*%\s*•\s*(.+)$/.exec(t);
    if (!m) return { factorPct: 0, factorLabel: "" };
    return { factorPct: Number(m[1]), factorLabel: String(m[2]).trim() };
  }

  async function saveRow(tr, recordId) {
    const getVal = (k) => {
      const el = tr.querySelector(`[data-in="${k}"]`);
      return el ? el.value.trim() : "";
    };

    const dataRilevazione = getVal("dataRilevazione");
    const areaContesto = getVal("areaContesto");
    const attivita = getVal("attivita");
    const partiInteressate = getVal("partiInteressate");
    const obiettivo = getVal("obiettivo");
    const fattoreTxt = getVal("fattore");

    const { factorPct, factorLabel } = parseFattoreCell(fattoreTxt);

    if (!dataRilevazione || !areaContesto || !attivita || !partiInteressate || !obiettivo || !factorPct || !factorLabel) {
      alert("Compila tutti i campi. Per il fattore usa: 50% • MEDIA MINACCIA (E)");
      return;
    }

    const payload = {
      mode: "update",
      apiKey: API_KEY,
      ts: pageLoadTs,
      hp: "",
      recordId,
      dataRilevazione,
      areaContesto,
      attivita,
      partiInteressate,
      obiettivo,
      factorPct,
      factorLabel
    };

    try {
      await fetch(WEB_APP_URL, {
        method: "POST",
        mode: "no-cors",
        headers: { "Content-Type": "text/plain;charset=utf-8" },
        body: JSON.stringify(payload)
      });

      // micro-delay + refresh
      setTimeout(async () => { await refresh(); }, 350);
    } catch (e) {
      alert("Errore update: " + e);
    }
  }

  // Avvio: caricamento iniziale tabella
  refresh();
</script>



