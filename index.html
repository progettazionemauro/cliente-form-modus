<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ISO 9001 – SWOT (Form + Viewer)</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; }
    .wrap { max-width: 1100px; margin: 22px auto; padding: 0 16px; }

    h1 { margin: 0 0 6px; }
    .muted { color:#666; font-size: .95rem; margin: 0 0 14px; }

    /* FORM */
    .card {
      border: 1px solid #e5e5e5;
      border-radius: 10px;
      padding: 14px;
      background: #fafafa;
    }
    label { display:block; margin: 10px 0 6px; font-weight: 600; }
    input, select, textarea {
      width: 100%;
      padding: 9px;
      box-sizing: border-box;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 14px;
      background: #fff;
    }
    textarea { min-height: 90px; resize: vertical; }

    .actions { margin-top: 12px; display:flex; gap: 10px; align-items:center; flex-wrap: wrap; }
    button {
      padding: 9px 12px;
      border: 0;
      border-radius: 8px;
      background: #1a73e8;
      color: #fff;
      cursor: pointer;
      font-weight: 600;
    }
    button.secondary { background: #666; }
    button:disabled { opacity: 0.6; cursor: not-allowed; }
    .ok { color: #0a6; font-weight: 600; }
    .err { color: #b00; font-weight: 600; }

    .pill { display:inline-block; padding: 4px 8px; border-radius: 999px; background:#eee; font-size: 12px; margin-left: 8px; color:#333; }
    .hint { font-size: 0.9rem; color: #555; margin-top: 6px; }
    .hidden { display:none; }

    /* VIEWER */
    .viewer {
      margin-top: 16px;
    }
    .toolbar {
      display:flex; gap: 10px; align-items:center; flex-wrap: wrap;
      margin: 10px 0;
    }
    .toolbar input { max-width: 320px; }

    .table-wrap {
      width: 100%;
      overflow: auto;
      border: 1px solid #e5e5e5;
      border-radius: 10px;
      background: #fff;
      max-height: 560px;
    }
    table { width: 100%; border-collapse: collapse; }
    th, td { border: 1px solid #eee; padding: 8px; vertical-align: top; }
    th { background: #f4f4f4; text-align: left; position: sticky; top: 0; z-index: 1; }
    .nowrap { white-space: nowrap; }

    /* Color coding (SWOT) */
    .tag { font-weight: 700; padding: 2px 6px; border-radius: 6px; display: inline-block; }
    .risk-low  { background: #e7f5ff; color:#0b5394; }   /* soft blue */
    .risk-mid  { background: #fff4e6; color:#7a4a00; }   /* soft orange */
    .risk-high { background: #ffe3e3; color:#8a0000; }   /* soft red */
    .pos-low   { background: #eafbea; color:#0b6b1c; }   /* soft green */
    .pos-mid   { background: #d7f5dc; color:#0b6b1c; }
    .pos-high  { background: #bff0c9; color:#0b6b1c; }

    .small { color:#666; font-size: 12px; }
  </style>
</head>

<body>
  <div class="wrap">
    <h1>ISO 9001 – SWOT</h1>
    <p class="muted">Inserimento + visualizzazione “tipo Excel” (refresh pagina forzato dopo invio).</p>

    <!-- FORM (in alto) -->
    <div class="card">
      <form id="f" autocomplete="on">
        <label for="dataRilevazione">Data rilevazione</label>
        <input id="dataRilevazione" name="dataRilevazione" type="date" required />
        <div class="hint">Seleziona dal calendario (salviamo in formato gg/mm/aa).</div>

        <label for="areaContesto">Area contesto</label>
        <select id="areaContesto" name="areaContesto" required>
          <option value="" selected disabled>Seleziona…</option>
          <option>ECONOMICO</option>
          <option>TECNOLOGICO</option>
          <option>LEGALE</option>
          <option>POLITICO / REGOLATORIO</option>
          <option>SOCIALE</option>
          <option>AMBIENTALE / CLIMATICO</option>
          <option>MERCATO / DOMANDA</option>
          <option>VENDITE E CUSTOMER CARE</option>
          <option>AREA FINANZA</option>
          <option>RISORSE UMANE</option>
          <option>INFRASTRUTTURE / ASSET</option>
          <option>SUPPLY CHAIN / FORNITORI</option>
          <option>QUALITÀ E PROCESSI</option>
          <option>CYBERSECURITY / IT</option>
          <option>LOGISTICA</option>
          <option>REPUTAZIONE / BRAND</option>
          <option>CONCORRENZA</option>
          <option>INNOVAZIONE / R&D</option>
          <option>COMPLIANCE / ETICA</option>
          <option>SALUTE E SICUREZZA (OHS)</option>
        </select>

        <label for="attivita">Attività</label>
        <textarea id="attivita" name="attivita" required placeholder="Descrivi attività / processo / evento…"></textarea>

        <label for="partiInteressate">Parti interessate</label>
        <select id="partiInteressate" name="partiInteressate" required>
          <option value="" selected disabled>Seleziona…</option>
          <option>CLIENTI</option>
          <option>PROSPECT / MERCATO POTENZIALE</option>
          <option>COMPETITORS</option>
          <option>FORNITORI</option>
          <option>PARTNER / ALLEANZE</option>
          <option>SOCIETÀ DI INGEGNERIA</option>
          <option>STUDI DI ARCHITETTURA</option>
          <option>CONSULENTI</option>
          <option>ISTITUTI DI CREDITO / BANCHE</option>
          <option>AGENZIA DELLE ENTRATE</option>
          <option>INAIL</option>
          <option>ENTI REGOLATORI / PA</option>
          <option>ORGANISMI DI CERTIFICAZIONE</option>
          <option>ASSICURAZIONI</option>
          <option>DIPENDENTI</option>
          <option>COLLABORATORI / FREELANCE</option>
          <option>PROPRIETÀ / SOCI</option>
          <option>COMUNITÀ LOCALE</option>
          <option>ASSOCIAZIONI DI CATEGORIA</option>
          <option>MEDIA / OPINIONE PUBBLICA</option>
        </select>

        <label for="obiettivo">Obiettivo</label>
        <textarea id="obiettivo" name="obiettivo" required placeholder="Obiettivo collegato al fattore (azione, risultato, KPI)…"></textarea>

        <label for="fattoreAnte">Fattore (ante) <span class="pill" id="pillFactor">—</span></label>
        <select id="fattoreAnte" name="fattoreAnte" required>
          <option value="" selected disabled>Seleziona…</option>

          <option value="25|BASSA MINACCIA (E)">25 - BASSA MINACCIA (E)</option>
          <option value="50|MEDIA MINACCIA (E)">50 - MEDIA MINACCIA (E)</option>
          <option value="75|ESTREMA MINACCIA (E)">75 - ESTREMA MINACCIA (E)</option>

          <option value="25|BASSA OPPORTUNITA (E)">25 - BASSA OPPORTUNITA (E)</option>
          <option value="50|MEDIA OPPORTUNITA (E)">50 - MEDIA OPPORTUNITA (E)</option>
          <option value="100|ESTREMA OPPORTUNITA (E)">100 - ESTREMA OPPORTUNITA (E)</option>

          <option value="25|BASSA DEBOLEZZA (I)">25 - BASSA DEBOLEZZA (I)</option>
          <option value="50|MEDIA DEBOLEZZA (I)">50 - MEDIA DEBOLEZZA (I)</option>
          <option value="100|ESTREMA DEBOLEZZA (I)">100 - ESTREMA DEBOLEZZA (I)</option>

          <option value="25|BASSA FORZA (I)">25 - BASSA FORZA (I)</option>
          <option value="50|MEDIA FORZA (I)">50 - MEDIA FORZA (I)</option>
          <option value="100|ESTREMA FORZA (I)">100 - ESTREMA FORZA (I)</option>
        </select>

        <!-- Honeypot -->
        <div class="hidden">
          <label>Se sei umano lascia vuoto</label>
          <input name="hp" tabindex="-1" autocomplete="off" />
        </div>

        <div class="actions">
          <button id="btn" type="submit">Inserisci</button>
          <button id="reloadBtn" class="secondary" type="button">Ricarica tabella</button>
          <input id="search" type="text" placeholder="Cerca (testo libero)..." />
          <span id="status" class="muted"></span>
          <span class="muted" id="count"></span>
        </div>
      </form>
    </div>

    <!-- VIEWER (sotto, full width) -->
    <div class="viewer">
      <div class="table-wrap">
        <table id="t">
          <thead>
            <tr>
              <th class="nowrap">Data</th>
              <th>Area contesto</th>
              <th>SWOT</th>
              <th class="nowrap">Grado</th>
              <th class="nowrap">ID breve</th>
            </tr>
          </thead>
          <tbody id="tb"></tbody>
        </table>
      </div>
      <p class="small" style="margin:8px 4px 0;">
        Nota: i colori sono applicati in GH Pages (non dipendono dalla formattazione di Google Sheets).
      </p>
    </div>
  </div>

  <script>
    // ===== CONFIG =====
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbznxZL1iXMew8yhfTixVfmF1dPI9_VUzo2_52wWpXdGzJ1lKoCP3hPB2hcDJZKCPLjb/exec";
    const API_KEY = "Djungo-Test-2026-01-17-chiave-lunga-XYZ";

    // Timestamp per anti-bot (server-side)
    const pageLoadTs = Date.now();

    const form = document.getElementById("f");
    const statusEl = document.getElementById("status");
    const btn = document.getElementById("btn");
    const reloadBtn = document.getElementById("reloadBtn");
    const searchEl = document.getElementById("search");
    const countEl = document.getElementById("count");
    const tb = document.getElementById("tb");

    const fattoreAnteEl = document.getElementById("fattoreAnte");
    const pillFactorEl = document.getElementById("pillFactor");

    let currentRows = [];

    function setStatus(msg, cls) {
      statusEl.className = cls || "muted";
      statusEl.textContent = msg;
    }

    function isoToDDMMYY(iso) {
      const m = /^(\d{4})-(\d{2})-(\d{2})$/.exec(iso);
      if (!m) return "";
      const yy = m[1].slice(2);
      return `${m[3]}/${m[2]}/${yy}`;
    }

    function escapeHtml(s) {
      return String(s)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    fattoreAnteEl.addEventListener("change", () => {
      const v = (fattoreAnteEl.value || "");
      if (!v) { pillFactorEl.textContent = "—"; return; }
      const [pct, label] = v.split("|");
      pillFactorEl.textContent = `${pct}% • ${label}`;
    });

    // ===== JSONP LIST =====
    function loadRows() {
      return new Promise((resolve) => {
        const cbName = "cb_" + Math.random().toString(36).slice(2);
        window[cbName] = (data) => {
          try { resolve(data); }
          finally { delete window[cbName]; }
        };

        const s = document.createElement("script");
        const url = new URL(WEB_APP_URL);
        url.searchParams.set("mode", "list");
        url.searchParams.set("apiKey", API_KEY);
        url.searchParams.set("callback", cbName);
        url.searchParams.set("limit", "400");
        url.searchParams.set("_", Date.now().toString()); // cache buster

        s.src = url.toString();
        s.onerror = () => resolve({ ok: false, error: "JSONP load error" });
        document.body.appendChild(s);

        // cleanup
        setTimeout(() => { try { document.body.removeChild(s); } catch (_) {} }, 1500);

        // safety timeout
        setTimeout(() => resolve({ ok: false, error: "JSONP timeout" }), 5000);
      });
    }

    function classifySwot(factorLabel, factorPct) {
      const label = String(factorLabel || "").toUpperCase();
      const pct = Number(factorPct || 0);

      const isThreat = label.includes("MINACCIA") || label.includes("DEBOLEZZA");
      const isOpportunity = label.includes("OPPORTUNITA") || label.includes("FORZA");

      const level =
        (pct >= 75) ? "high" :
        (pct >= 50) ? "mid" : "low";

      if (isThreat) return "risk-" + level;
      if (isOpportunity) return "pos-" + level;
      return "risk-low";
    }

    function render(rows) {
      const q = (searchEl.value || "").trim().toLowerCase();
      const filtered = !q ? rows : rows.filter(r => {
        const blob = [
          r.dataRilevazione, r.areaContesto, r.factorLabel,
          String(r.factorPct || ""), r.recordId
        ].join(" ").toLowerCase();
        return blob.includes(q);
      });

      tb.innerHTML = "";
      const ordered = filtered.slice().reverse();

      for (const r of ordered) {
        const swotClass = classifySwot(r.factorLabel, r.factorPct);
        const shortId = (r.recordId || "").slice(0, 8);

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="nowrap">${escapeHtml(r.dataRilevazione || "")}</td>
          <td>${escapeHtml(r.areaContesto || "")}</td>
          <td><span class="tag ${swotClass}">${escapeHtml(r.factorLabel || "")}</span></td>
          <td class="nowrap">${escapeHtml(String(r.factorPct || ""))}%</td>
          <td class="nowrap"><code>${escapeHtml(shortId)}</code></td>
        `;
        tb.appendChild(tr);
      }

      countEl.textContent = `Righe: ${filtered.length} / ${rows.length}`;
    }

    async function refresh() {
      countEl.textContent = "Caricamento...";
      const data = await loadRows();
      if (!data || !data.ok) {
        countEl.textContent = "Errore caricamento.";
        return;
      }
      currentRows = data.rows || [];
      render(currentRows);
    }

    reloadBtn.addEventListener("click", refresh);
    searchEl.addEventListener("input", () => render(currentRows));

    // ===== INSERT (REFRESH PAGINA FORZATO) =====
    form.addEventListener("submit", async (ev) => {
      ev.preventDefault();
      btn.disabled = true;
      setStatus("Invio in corso...", "muted");

      const fd = new FormData(form);

      const isoDate = (fd.get("dataRilevazione") || "").toString().trim();
      const dataRilevazione = isoToDDMMYY(isoDate);

      const areaContesto = (fd.get("areaContesto") || "").toString().trim();
      const attivita = (fd.get("attivita") || "").toString().trim();
      const partiInteressate = (fd.get("partiInteressate") || "").toString().trim();
      const obiettivo = (fd.get("obiettivo") || "").toString().trim();
      const fattoreAnte = (fd.get("fattoreAnte") || "").toString().trim();
      const hp = (fd.get("hp") || "").toString();

      if (!dataRilevazione || !areaContesto || !attivita || !partiInteressate || !obiettivo || !fattoreAnte) {
        setStatus("Compila tutti i campi obbligatori.", "err");
        btn.disabled = false;
        return;
      }

      const [factorPctStr, factorLabel] = fattoreAnte.split("|");
      const factorPct = Number(factorPctStr || 0);

      const payload = {
        mode: "insert",
        apiKey: API_KEY,
        ts: pageLoadTs,
        hp,
        dataRilevazione,
        areaContesto,
        attivita,
        partiInteressate,
        obiettivo,
        factorPct,
        factorLabel
      };

      try {
        await fetch(WEB_APP_URL, {
          method: "POST",
          mode: "no-cors",
          headers: { "Content-Type": "text/plain;charset=utf-8" },
          body: JSON.stringify(payload)
        });

        setStatus("Inserito. Aggiorno pagina…", "ok");

        // ✅ QUI LA SOLA MODIFICA CHE VOLEVI:
        // forzo il refresh pagina (niente “draghi”)
        setTimeout(() => {
          window.location.reload();
        }, 350);

      } catch (e) {
        setStatus("Errore di rete: " + e, "err");
        btn.disabled = false;
      }
    });

    // avvio
    refresh();
  </script>
</body>
</html>





