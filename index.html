<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ISO 9001 - Contesto & SWOT (Form + Viewer)</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 1200px; margin: 28px auto; padding: 0 16px; }
    h1 { margin: 0 0 6px; }
    .muted { color: #666; font-size: 0.95rem; margin: 0 0 16px; }
    .card { border: 1px solid #e5e5e5; border-radius: 10px; padding: 14px; background: #fafafa; margin-bottom: 14px; }
    label { display:block; margin: 10px 0 6px; font-weight: 600; }
    input, select, textarea { width: 100%; padding: 9px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 6px; font-size: 14px; background: #fff; }
    textarea { min-height: 90px; resize: vertical; }
    .actions { margin-top: 12px; display:flex; gap: 10px; align-items:center; flex-wrap: wrap; }
    button { padding: 9px 12px; border: 0; border-radius: 8px; background: #1a73e8; color: #fff; cursor: pointer; font-weight: 600; }
    button.secondary { background: #666; }
    button:disabled { opacity: 0.6; cursor: not-allowed; }
    .ok { color: #0a6; font-weight: 600; }
    .err { color: #b00; font-weight: 600; }
    iframe { width: 100%; height: 620px; border: 1px solid #ddd; border-radius: 10px; background: #fff; }
    details { background:#fff; border:1px solid #e5e5e5; border-radius:8px; padding:10px; margin-top:12px; }
    .readonly-hint { font-size: 0.9rem; color:#555; margin-top: 6px; }
  </style>
</head>

<body>
  <h1>ISO 9001 – Contesto & SWOT</h1>
  <p class="muted">Inserimento su <b>SWOT_input</b>. Viewer: estratto max 20 righe.</p>

  <div class="card">
    <h3 style="margin:0 0 10px;">Nuova riga (ANTE + POST opzionale)</h3>

    <form id="insertForm" autocomplete="on">
      <label for="anno">Anno (ANTE)</label>
      <select id="anno" name="anno" required></select>

      <label for="contesto">Contesto (ANTE)</label>
      <select id="contesto" name="contesto" required>
        <option value="" selected disabled>Seleziona…</option>
        <option>ECONOMICO</option>
        <option>TECNOLOGICO</option>
        <option>LEGALE</option>
        <option>POLITICO / REGOLATORIO</option>
        <option>SOCIALE</option>
        <option>AMBIENTALE / CLIMATICO</option>
        <option>MERCATO / DOMANDA</option>
        <option>VENDITE E CUSTOMER CARE</option>
        <option>AREA FINANZA</option>
        <option>RISORSE UMANE</option>
        <option>INFRASTRUTTURE / ASSET</option>
        <option>SUPPLY CHAIN / FORNITORI</option>
        <option>QUALITÀ E PROCESSI</option>
        <option>CYBERSECURITY / IT</option>
        <option>LOGISTICA</option>
        <option>REPUTAZIONE / BRAND</option>
        <option>CONCORRENZA</option>
        <option>INNOVAZIONE / R&D</option>
        <option>COMPLIANCE / ETICA</option>
        <option>SALUTE E SICUREZZA (OHS)</option>
      </select>

      <label for="attivita">Attività</label>
      <textarea id="attivita" name="attivita" required></textarea>

      <label for="partiInteressate">Parti interessate (ANTE)</label>
      <select id="partiInteressate" name="partiInteressate" required>
        <option value="" selected disabled>Seleziona…</option>
        <option>CLIENTI</option>
        <option>PROSPECT / MERCATO POTENZIALE</option>
        <option>COMPETITORS</option>
        <option>FORNITORI</option>
        <option>PARTNER / ALLEANZE</option>
        <option>SOCIETÀ DI INGEGNERIA</option>
        <option>STUDI DI ARCHITETTURA</option>
        <option>CONSULENTI</option>
        <option>ISTITUTI DI CREDITO / BANCHE</option>
        <option>AGENZIA DELLE ENTRATE</option>
        <option>INAIL</option>
        <option>ENTI REGOLATORI / PA</option>
        <option>ORGANISMI DI CERTIFICAZIONE</option>
        <option>ASSICURAZIONI</option>
        <option>DIPENDENTI</option>
        <option>COLLABORATORI / FREELANCE</option>
        <option>PROPRIETÀ / SOCI</option>
        <option>COMUNITÀ LOCALE</option>
        <option>ASSOCIAZIONI DI CATEGORIA</option>
        <option>MEDIA / OPINIONE PUBBLICA</option>
      </select>

      <label for="obiettivoAnte">Obiettivo (ANTE)</label>
      <textarea id="obiettivoAnte" name="obiettivoAnte" required></textarea>

      <label for="swotAnte">SWOT (ANTE)</label>
      <select id="swotAnte" name="swotAnte" required>
        <option value="" selected disabled>Seleziona…</option>
        <option>25 - BASSA MINACCIA (E)</option>
        <option>50 - MEDIA MINACCIA (E)</option>
        <option>75 - ESTREMA MINACCIA (E)</option>
        <option>25 - BASSA OPPORTUNITA (E)</option>
        <option>50 - MEDIA OPPORTUNITA (E)</option>
        <option>100 - ESTREMA OPPORTUNITA (E)</option>
        <option>25 - BASSA DEBOLEZZA (I)</option>
        <option>50 - MEDIA DEBOLEZZA (I)</option>
        <option>100 - ESTREMA DEBOLEZZA (I)</option>
        <option>25 - BASSA FORZA (I)</option>
        <option>50 - MEDIA FORZA (I)</option>
        <option>100 - ESTREMA FORZA (I)</option>
      </select>

      <label for="fattoreIEAnte">Fattore Interno - Esterno (ANTE) (auto)</label>
      <input id="fattoreIEAnte" name="fattoreIEAnte" readonly />
      <div class="readonly-hint">Derivato automaticamente da SWOT: (E)=Esterno, (I)=Interno.</div>

      <label for="roAnte">R / O (ANTE)</label>
      <select id="roAnte" name="roAnte" required>
        <option value="" selected disabled>Seleziona…</option>
        <option>RISCHIO</option>
        <option>OPPORTUNITA'</option>
      </select>

      <details>
        <summary><b>Sezione POST (opzionale)</b></summary>

        <label for="annoPost">Anno di Rilevazione (POST)</label>
        <select id="annoPost" name="annoPost"></select>

        <label for="esitoPost">Esito POST</label>
        <select id="esitoPost" name="esitoPost">
          <option value="" selected>—</option>
          <option>RAGGIUNTO</option>
          <option>NON RAGGIUNTO</option>
        </select>

        <label for="swotPost">SWOT (POST)</label>
        <select id="swotPost" name="swotPost">
          <option value="" selected>—</option>
          <option>25 - BASSA MINACCIA (E)</option>
          <option>50 - MEDIA MINACCIA (E)</option>
          <option>75 - ESTREMA MINACCIA (E)</option>
          <option>25 - BASSA OPPORTUNITA (E)</option>
          <option>50 - MEDIA OPPORTUNITA (E)</option>
          <option>100 - ESTREMA OPPORTUNITA (E)</option>
          <option>25 - BASSA DEBOLEZZA (I)</option>
          <option>50 - MEDIA DEBOLEZZA (I)</option>
          <option>100 - ESTREMA DEBOLEZZA (I)</option>
          <option>25 - BASSA FORZA (I)</option>
          <option>50 - MEDIA FORZA (I)</option>
          <option>100 - ESTREMA FORZA (I)</option>
        </select>

        <label for="fattoreIEPost">Fattore Interno - Esterno (POST) (auto)</label>
        <input id="fattoreIEPost" name="fattoreIEPost" readonly />
        <div class="readonly-hint">Derivato automaticamente da SWOT: (E)=Esterno, (I)=Interno.</div>

        <label for="roPost">R / O (POST)</label>
        <select id="roPost" name="roPost">
          <option value="" selected>—</option>
          <option>RISCHIO</option>
          <option>OPPORTUNITA'</option>
        </select>

        <label for="commentoPost">Commento POST</label>
        <textarea id="commentoPost" name="commentoPost" placeholder="Note / motivazioni / cambiamenti"></textarea>
      </details>

      <div class="actions">
        <button id="insertBtn" type="submit">Inserisci</button>
        <span id="insertStatus" class="muted"></span>
      </div>
    </form>
  </div>

  <div class="card">
    <h3 style="margin:0 0 10px;">Viewer (max 20 righe)</h3>
    <p class="muted">Il viewer è <b>viewer.html</b> e riceve l’endpoint da questa pagina.</p>

    <iframe id="sheetFrame" loading="lazy"></iframe>

    <div class="actions">
      <button id="viewerRefreshBtn" type="button" class="secondary">Aggiorna viewer</button>
      <span class="muted">Forza refresh (cache-bust).</span>
    </div>
  </div>

  <script>
    // ===== CONFIG (UNICO PUNTO DA MODIFICARE) =====
    const WEB_APP_URL = " https://script.google.com/macros/s/AKfycbw24MZtgQ8EDQcOXqtIJhjOey6PKzT_Uq9fNNwhHLmULWjA7IVPe0Kp3jXUnngXckgt/exec";
   
    
    const API_KEY = "Djungo-Test-2026-01-17-chiave-lunga-XYZ";

    function setMsg(el, msg, cls) {
      el.className = cls || "muted";
      el.textContent = msg;
    }

    function jsonp(url) {
      return new Promise((resolve, reject) => {
        const cbName = "cb_" + Math.random().toString(36).slice(2);
        const script = document.createElement("script");
        const timeout = setTimeout(() => { cleanup(); reject(new Error("Timeout JSONP")); }, 15000);

        function cleanup() {
          clearTimeout(timeout);
          script.remove();
          try { delete window[cbName]; } catch (_) { window[cbName] = undefined; }
        }

        window[cbName] = (data) => { cleanup(); resolve(data); };

        const u = new URL(url);
        u.searchParams.set("cb", cbName);
        script.src = u.toString();
        script.onerror = () => { cleanup(); reject(new Error("JSONP load error")); };
        document.body.appendChild(script);
      });
    }

    // ===== anni dropdown 2020-2030 =====
    function fillYears(selectEl, start=2020, end=2030, allowEmpty=false) {
      selectEl.innerHTML = "";
      if (allowEmpty) {
        const opt0 = document.createElement("option");
        opt0.value = "";
        opt0.textContent = "—";
        selectEl.appendChild(opt0);
      } else {
        const opt0 = document.createElement("option");
        opt0.value = "";
        opt0.textContent = "Seleziona…";
        opt0.disabled = true;
        opt0.selected = true;
        selectEl.appendChild(opt0);
      }
      for (let y=start; y<=end; y++) {
        const opt = document.createElement("option");
        opt.value = String(y);
        opt.textContent = String(y);
        selectEl.appendChild(opt);
      }
    }

    fillYears(document.getElementById("anno"), 2020, 2030, false);
    fillYears(document.getElementById("annoPost"), 2020, 2030, true);

    // ===== derivazione Fattore IE da SWOT =====
    function deriveIE(swotText) {
      const s = String(swotText || "");
      if (s.includes("(E)")) return "Fattore Esterno";
      if (s.includes("(I)")) return "Fattore Interno";
      return "";
    }

    const swotAnteEl = document.getElementById("swotAnte");
    const swotPostEl = document.getElementById("swotPost");
    const fattoreIEAnteEl = document.getElementById("fattoreIEAnte");
    const fattoreIEPostEl = document.getElementById("fattoreIEPost");

    swotAnteEl.addEventListener("change", () => {
      fattoreIEAnteEl.value = deriveIE(swotAnteEl.value);
    });

    swotPostEl.addEventListener("change", () => {
      fattoreIEPostEl.value = deriveIE(swotPostEl.value);
    });

    // ===== viewer iframe (passa config al viewer una sola volta) =====
    const sheetFrame = document.getElementById("sheetFrame");
    const viewerRefreshBtn = document.getElementById("viewerRefreshBtn");

    function currentDirBase() {
      return window.location.pathname.replace(/[^\/]*$/, "");
    }

    function viewerUrl(cacheBust) {
      const base = currentDirBase();
      const u = new URL(base + "viewer.html", window.location.origin);
      u.searchParams.set("webApp", WEB_APP_URL);
      u.searchParams.set("apiKey", API_KEY);
      u.searchParams.set("debug", "1"); // <<< SOLO PER DEBUG
      if (cacheBust) u.searchParams.set("_", Date.now().toString());
      return u.toString();
    }

    function loadViewer(cacheBust) {
      sheetFrame.src = viewerUrl(!!cacheBust);
    }

    viewerRefreshBtn.addEventListener("click", () => loadViewer(true));
    loadViewer(false);

    // ===== INSERT =====
    const insertForm = document.getElementById("insertForm");
    const insertBtn = document.getElementById("insertBtn");
    const insertStatus = document.getElementById("insertStatus");

    insertForm.addEventListener("submit", async (ev) => {
  ev.preventDefault();
  insertBtn.disabled = true;
  setMsg(insertStatus, "Invio in corso...", "muted");

  const fd = new FormData(insertForm);

  // Validazione minima: fattore IE deve essere derivabile
  const swotAnteVal = (fd.get("swotAnte") || "").toString().trim();
  const ieAnte = deriveIE(swotAnteVal);
  if (!ieAnte) {
    setMsg(insertStatus, "Errore: SWOT (ANTE) deve contenere (E) oppure (I).", "err");
    insertBtn.disabled = false;
    return;
  }

  const swotPostVal = (fd.get("swotPost") || "").toString().trim();
  const iePost = swotPostVal ? deriveIE(swotPostVal) : "";
  if (swotPostVal && !iePost) {
    setMsg(insertStatus, "Errore: SWOT (POST) deve contenere (E) oppure (I).", "err");
    insertBtn.disabled = false;
    return;
  }

  const u = new URL(WEB_APP_URL);
  u.searchParams.set("mode", "insert");
  u.searchParams.set("apiKey", API_KEY);

  // >>> DEBUG (mettilo QUI, una sola volta) <<<
  u.searchParams.set("debug", "1");

  // ANTE
  u.searchParams.set("anno", (fd.get("anno") || "").toString().trim());
  u.searchParams.set("contesto", (fd.get("contesto") || "").toString().trim());
  u.searchParams.set("attivita", (fd.get("attivita") || "").toString().trim());
  u.searchParams.set("partiInteressate", (fd.get("partiInteressate") || "").toString().trim());
  u.searchParams.set("obiettivoAnte", (fd.get("obiettivoAnte") || "").toString().trim());
  u.searchParams.set("swotAnte", swotAnteVal);

  // >>> AUTO derivati da SWOT (consigliato inviarli per evitare mismatch col backend) <<<
  u.searchParams.set("fattoreIEAnte", ieAnte);

  // R/O (se vuoi che lo calcoli Sheets, puoi anche NON inviarlo; ma se Code.gs lo richiede, invialo)
  u.searchParams.set("roAnte", (fd.get("roAnte") || "").toString().trim());

  // POST (opzionale) — attenzione: nel tuo HTML si chiama annoRilevazionePost
  u.searchParams.set("annoRilevazionePost", (fd.get("annoRilevazionePost") || "").toString().trim()); // YYYY-MM-DD oppure "" se vuoto
  u.searchParams.set("esitoPost", (fd.get("esitoPost") || "").toString().trim());
  u.searchParams.set("swotPost", swotPostVal);

  // >>> AUTO derivato da SWOT POST <<<
  u.searchParams.set("fattoreIEPost", iePost);

  u.searchParams.set("roPost", (fd.get("roPost") || "").toString().trim());
  u.searchParams.set("commentoPost", (fd.get("commentoPost") || "").toString().trim());

  try {
    const resp = await jsonp(u.toString());
    console.log("INSERT resp =", JSON.stringify(resp, null, 2));

    if (!resp || resp.ok !== true) {
      setMsg(insertStatus, "Errore: " + (resp && resp.error ? resp.error : "Risposta non valida"), "err");
      return;
    }

    setMsg(insertStatus, `Inserito (ID=${resp.id || "?"}). Aggiorno viewer…`, "ok");
    insertForm.reset();

    // Se hai campi auto visivi in pagina, azzerali (se esistono davvero nel tuo DOM)
    if (typeof fattoreIEAnteEl !== "undefined" && fattoreIEAnteEl) fattoreIEAnteEl.value = "";
    if (typeof fattoreIEPostEl !== "undefined" && fattoreIEPostEl) fattoreIEPostEl.value = "";

    loadViewer(true);

  } catch (e) {
    setMsg(insertStatus, "Errore rete/JSONP: " + e.message, "err");
  } finally {
    insertBtn.disabled = false;
  }
});

  </script>
</body>
</html>









